<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Deployment of the Full System &mdash; kodiaq 0.9 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.1.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.1.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/bstheme.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <script type="text/javascript" src="_static/theme.js"></script>
    <link rel="top" title="kodiaq 0.9 documentation" href="index.html" />
    <link rel="next" title="DAQ Options" href="options.html" />
    <link rel="prev" title="Using the Standalone Reader" href="usage.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

<div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">
        kodiaq</a>
      <span class="navbar-text navbar-version pull-left"><b>0.9</b></span>
    </div>
    
    <div class="collapse navbar-collapse"><!-- nav-collapse">-->
      <ul class="nav navbar-nav pull-right">
        <!--<li class="divider-vertical"></li>  -->
        
        
        
        
         
            

<li>
    <a href="usage.html" title="Previous Chapter: Using the Standalone Reader"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Using the Standa...</span>
    </a>
  </li>
  <li>
    <a href="options.html" title="Next Chapter: DAQ Options"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">DAQ Options &raquo;</span>
    </a>
  </li>
          
        
        
        
        
      </ul>
      
      <!--          
		    
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
		     -->
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
      <div class="col-md-3" id="leftCol">
        <!--<div id="sidebar" class="bs-sidenav" role="complementary"> -->
	<br><br>
	<ul id="sidebar" class="nav nav-stacked"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="webinterface.html">A Tour of the Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation of the standalone reader</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using the Standalone Reader</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Deployment of the Full System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#summary-of-dependencies-per-module">Summary of Dependencies per Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-step-by-step">Deployment, Step by Step</a></li>
<li class="toctree-l2"><a class="reference internal" href="#general-network-structure">General network structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#koslave">koSlave</a></li>
<li class="toctree-l2"><a class="reference internal" href="#komaster">koMaster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#run-modes">Run Modes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="options.html">DAQ Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="protocols.html">Data Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoringdatabase.html">Monitoring DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoringdatabase.html#run-modes">Run Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="jargon.html">Jargon Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Help</a></li>
</ul>

<!--<li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Welcome</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intro.html#scope-of-the-program">Scope of the program</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#use-guidelines">Use Guidelines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="webinterface.html">A Tour of the Web Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="webinterface.html#introduction">Introduction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation of the standalone reader</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#fetching-the-source-code">Fetching the source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#prerequisites-for-installation">Prerequisites for installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#how-to-install">How to install</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using the Standalone Reader</a><ul>
<li class="toctree-l2"><a class="reference internal" href="usage.html#special-options-for-standalone-mode">Special options for standalone mode</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Deployment of the Full System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#summary-of-dependencies-per-module">Summary of Dependencies per Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deployment-step-by-step">Deployment, Step by Step</a></li>
<li class="toctree-l2"><a class="reference internal" href="#general-network-structure">General network structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#koslave">koSlave</a></li>
<li class="toctree-l2"><a class="reference internal" href="#komaster">koMaster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#run-modes">Run Modes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="options.html">DAQ Options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="options.html#general-syntax">General Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="options.html#electronics-definitions">Electronics Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="options.html#run-options">Run Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="options.html#output-options">Output Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="options.html#vme-options">VME Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="protocols.html">Data Formats</a><ul>
<li class="toctree-l2"><a class="reference internal" href="protocols.html#mongodb">Mongodb</a><ul>
<li class="toctree-l3"><a class="reference internal" href="protocols.html#run-control-document">Run Control Document</a></li>
<li class="toctree-l3"><a class="reference internal" href="protocols.html#data-documents">Data Documents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="monitoringdatabase.html">Monitoring DB</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoringdatabase.html#run-modes">Run Modes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="monitoringdatabase.html#registers">Registers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="jargon.html">Jargon Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Help</a></li>
</ul>
</ul>
</li> -->
<form action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </ul>
      </div>
    <div class="col-md-9">
      
  <div class="section" id="deployment-of-the-full-system">
<h1>Deployment of the Full System<a class="headerlink" href="#deployment-of-the-full-system" title="Permalink to this headline">¶</a></h1>
<p>kodiaq consists of two parts:</p>
<ul class="simple">
<li>The master module runs on one computer and manages the entire system</li>
<li>Slave modules run on each readout PC and drive the boards</li>
</ul>
<p>Both of these modules are required for running in networked mode. Installation and
configuration of the modules will be described in this section.</p>
<p>Both modules require the libkodiaq, which is compiled
automatically no matter which options are given. The libkodiaq library contains
shared code for the network protocols, options file handling, logging,
and other assorted helper functions. The source for this library is
found in src/common.</p>
<p>Building the software is done using autotools. Line-by-line
instructions are given below for each module, however in general the
software is simply compiled by calling:</p>
<div class="highlight-python"><div class="highlight"><pre>./configure --enable-all
make
</pre></div>
</div>
<p>Some of the modules have unique dependencies not shared by the others.
For example the master module require the mongodb driver
while the slave module does not (if no mongodb output is needed).
The configure script has several
flags that tell kodiaq which modules to include.</p>
<table border="1" class="table-hover docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>{no arguments}</td>
<td>Compile the lite module only</td>
</tr>
<tr class="row-odd"><td>&#8211;enable-slave</td>
<td>Compile the slave module</td>
</tr>
<tr class="row-even"><td>&#8211;enable-master</td>
<td>Compile the master module</td>
</tr>
<tr class="row-odd"><td>&#8211;enable-ddc10</td>
<td>Enable ddc-10 support for master</td>
</tr>
<tr class="row-even"><td>&#8211;enable-lite</td>
<td>Compile standalone slave module</td>
</tr>
<tr class="row-odd"><td>&#8211;enable-all</td>
<td>Compile all modules</td>
</tr>
</tbody>
</table>
<p>In all cases the shared common directory is compiled. For each option
enabled the configure script automatically checks that the unique
dependencies for each module are installed. The make script then
compiles only the activated modules.</p>
<div class="section" id="summary-of-dependencies-per-module">
<h2>Summary of Dependencies per Module<a class="headerlink" href="#summary-of-dependencies-per-module" title="Permalink to this headline">¶</a></h2>
<table border="1" class="table-hover docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Module</th>
<th class="head">Dependencies</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>common</td>
<td><div class="first last line-block">
<div class="line">* c++ compiler (i.e. gcc)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>slave/lite</td>
<td><div class="first last line-block">
<div class="line">* libpthread-dev</div>
<div class="line">* libCAENVME</div>
<div class="line">* libsnappy-dev</div>
<div class="line">* libmongoclient (if mongodb output</div>
<div class="line-block">
<div class="line">is required)</div>
</div>
<div class="line">* libprotobuf-dev (if file output</div>
<div class="line-block">
<div class="line">is required</div>
</div>
</div>
</td>
</tr>
<tr class="row-even"><td>master</td>
<td><div class="first last line-block">
<div class="line">* libmongoclient</div>
<div class="line">* libboost-all-dev</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>ddc10</td>
<td><div class="first last line-block">
<div class="line">* libtcl8.5</div>
<div class="line">* libexpect</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="deployment-step-by-step">
<h2>Deployment, Step by Step<a class="headerlink" href="#deployment-step-by-step" title="Permalink to this headline">¶</a></h2>
<p>Here is a general outline of the steps needed to deploy a system. More
specific information on each step will be found in later sections.</p>
<ol class="arabic simple">
<li>Hook up the hardware. A readout PC (from now on called a slave)
needs a CAEN A2818 or A3818 PCI(e) card. Up to 8 digitizers can
be hooked up in daisy chain via optical link. You also need one V2718 crate
controller with LEMO output &#8216;0&#8217; fanned to the s-in of all digitizers.</li>
<li>Install the koSlave module on each slave PC. Start the daemon in
a detached screen.</li>
<li>Find a spot for the master module to live. It is suggested to
use an independent PC as dispatcher but also possible to install
it alongside a slave. Install the master here. Make sure the
linkage between master and slave is defined correctly. Start the
master daemon in a detached screen. Follow the on-screen prompt to bring up the network.</li>
<li>Write your options file. Use the default as a base. You will
need to define the physical electronics setup exactly. If using a web database you can
use the UI to define your options.</li>
<li>Log into the web database and start the DAQ. Or start the DAQ from the command line using
the master module (less cool but works).</li>
</ol>
<p>The specifics on installing the slave and master, as well as how to
write an options file are given in the next sections.</p>
</div>
<div class="section" id="general-network-structure">
<h2>General network structure<a class="headerlink" href="#general-network-structure" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s a good idea to know a bit about how the networked mode actually works since the options
will make a little more sense. Basically you have a single instance of koMaster which acts as a dispatcher
and communicates with all the slave nodes and with an outside database. All the slave nodes connect to
this dispatcher. The connection is done over two ports. One port is interactive and is used for commands
and responses from the dispatcher to the slaves and vice versa. The other port is used to transmit a
constant stream of data from the slaves to the dispatcher which reports the rate, run mode, status, etc.</p>
<p>The master additionally supports independent operation of multiple detectors over the same dispatcher. Each
detector is basically its own independent deployment but they can also be operated together. Detectors are
defined in the master config file and each detector operates over two unique ports.</p>
<p>Within a single detector the slaves are organized such that each has its own ID number and name. The ID numbers
are integers and are used to define different options for different slaves. In the .ini file you can send an
option to a specific slave by prefacing a line with &#8216;%n&#8217; where &#8216;n&#8217; is the ID number of the slave. The name of
each slave can be anything and is used in status reporting.</p>
<p>If you want to use the DAQ with the web interface you need a mongodb database set up. The connectivity to this DB
is defined in the koMaster section below.</p>
</div>
<div class="section" id="koslave">
<h2>koSlave<a class="headerlink" href="#koslave" title="Permalink to this headline">¶</a></h2>
<p>The kodiaq slave module is the meat of the acquisition system. It
contains all the classes for controlling the V1724 digitizers as well
as pushing the data stream to mongodb. The koSlave module is a daemon
that runs all the time and listens for connections to the master.</p>
<p>There are several dependencies that must be met for the slave module
to work.</p>
<ul>
<li><dl class="first docutils">
<dt>You need a PC with a CAEN A2818 or A3818 PCI(-e) card installed</dt>
<dd><p class="first last">and also the proper drivers.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>There are several library dependencies</dt>
<dd><ul class="first last simple">
<li>CAENVMElib (available from CAEN, this is a closed-source
library)</li>
<li>mongodb cxx driver greater than version 2.6. Specifically
lbmongoclient is needed.</li>
<li>libsnappy for on-the-fly compression</li>
<li>libpthread for parallel processing</li>
<li>libpbf for file output</li>
<li>Normal build libraries (build-essential package on ubuntu) as well as automake, autotools, and libtool</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is possible to compile without libmongoclient and/or libpbf. If you compile without libmongoclient you will not be able to output to a mongodb. If you compile without libpbf you will not be able to write to file. Depending on your installation one of these may be fine. You will be notified at the end of the configure script which output forms are available for your installation.</p>
</div>
<p>Assuming you want to install everything, do it as follows.:</p>
<div class="highlight-python"><div class="highlight"><pre>apt-get install libsnappy-dev build-essential git-core scons libprotobuf-dev protobuf-compiler libboost-all-dev automake autotools libtool
</pre></div>
</div>
<p>Now make a directory for the code and install libpbf:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir kodiaq
cd kodiaq
git clone https://github.com/coderdj/libpbf.git libpbf
cd libpbf
make
make install
cd ..
</pre></div>
</div>
<p>We also want a newer version of mongodb so we can install that as well:</p>
<div class="highlight-python"><div class="highlight"><pre>git clone https://github.com/mongodb/mongo-cxx-driver.git mongodb
cd mongodb
git checkout 26compat    #currently for 2.6 compatible driver
scons --use-system-boost --full install-mongoclient
cd ..
</pre></div>
</div>
<p>Since mongo seems to change procedures and requirements with nearly every release you may prefer to check their most recent documentation.</p>
<p>Checkout the DAQ code from github as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>git clone https://github.com/XENON1T/kodiaq.git kodiaq
</pre></div>
</div>
<p>Now compile the CAEN software. There is a copy of this bundled with kodiaq or you can get the most recent versions from <a class="reference external" href="http://www.caen.it">http://www.caen.it</a>. The CAEN software is in kodiaq/caen. You need to install CAENVMElib and the driver for your PCI card (A2818 or A3818). The instructions for installation are given in the README files within these directories.</p>
<p>Everything should be in place so you can now compile the kodiaq package itself.:</p>
<div class="highlight-python"><div class="highlight"><pre>cd kodiaq (top-level directory)
./configure --enable-slave
make
</pre></div>
</div>
<p>The connection to the master must also be defined. This is defined in the file src/slave/SlaveConfig.ini,
which looks as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>SERVERADDR xedaq02
COM_PORT 2002
DATA_PORT 2003
NAME xedaq01
ID 1
</pre></div>
</div>
<p>This examples defines slave &#8216;xedaq01&#8217; with ID &#8216;1&#8217; to use ports 2002 and 2003 to
try to connect to the server at hostname xedaq02. The ports given must correspond
to a detector defined in src/master/MasterConfig.ini (see below) or the slave will
never be contacted by the network and will just listen perpetually. The server address
can be an IP address or a hostname. The NAME should be a single unique string (any words
beyond the first one are ignored). The ID should be a single digit between 0 and 9 and is
used to uniquely identify this slave from the dispatcher.</p>
<p>To start the slave just run koSlave, preferably in a detached screen.
The program will automatically scan the master and check to see if
it puts the network up. If so the slave will connect automatically.</p>
<p>In case that the slave loses connection it will stop the DAQ and
return to this idle state, waiting for another connection to the
master. It is designed to be left running indefinitely regardless of whether the DAQ is used or not.</p>
</div>
<div class="section" id="komaster">
<h2>koMaster<a class="headerlink" href="#komaster" title="Permalink to this headline">¶</a></h2>
<p>The master should be installed somewhere with a reliable network connection to the slaves. It can also run on a slave PC if necessary. Two open ports are required for communication with slaves and two more for communication with clients. These can be any ports but they must be defined in koSlave and in the UI.</p>
<p>To install the master, the mongodb C++ driver (version &gt;=2.6) must be installed (libmongoclient). You can follow the directions in the appropriate section of the koSlave installation instructions.</p>
<p>To build use the following:</p>
<div class="highlight-python"><div class="highlight"><pre>cd kodiaq
./configure --enable-master (--enable-ddc10 for ddc10 support)
make
</pre></div>
</div>
<p>The executable is in src/master/koMaster. This should also be run in a
detached screen and can be left on more or less indefinitely unless
there are issues.</p>
<p>The options for the master are stored in a configuration file in src/master at MasterConfig.ini. The options look as follows</p>
<div class="highlight-python"><div class="highlight"><pre>MONITOR_DB online        // name of monitoring database
MONITOR_ADDR xedaq01     // address of mongodb server (hostname or IP)
DETECTOR tpc 2002 2003   // define detector &#39;tpc&#39; to communicate over ports 2002 and 2003
DETECTOR muon_veto 2004 2005  // define detector &#39;muon_veto&#39; to communicate over ports 2004 and 2005
</pre></div>
</div>
<p>The detector names allow the web interface to send specific commands to specific detectors only.</p>
<p>The DDC-10 module uses telnet and requires libtcl8.5 and libexpect.</p>
<div class="section" id="run-modes">
<h3>Run Modes<a class="headerlink" href="#run-modes" title="Permalink to this headline">¶</a></h3>
<p>The operational mode for the DAQ can be pulled from an online mongodb database
or defined in a local file (src/master/DAQConfig.ini). The options with explanations are
found later in this document or in src/master/data/RunModes/DAQOptionsMaster.ini.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, Daniel Coderre.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>